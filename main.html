<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Juego Multijugador</title>
    <style>
        /* Estilos para el mapa y jugadores */
        /* ... */
    </style>
</head>
<body>
    <canvas id="game-canvas" width="800" height="600"></canvas>

    <script>
        // Configuración del cliente WebSocket
        const socket = new WebSocket('ws://192.168.100.165:8765');

        socket.onopen = function() {
            console.log('Conexión WebSocket establecida');
            
        };

        socket.onmessage = function(event) {
            const message = event.data;
            console.log('Mensaje recibido:', message);

            // Procesar el mensaje recibido del servidor
            if (message.includes('create')) {
                alert('Sala creada', message);
            } else if (message.includes('join')) {
                alert('Sala unida', message);
            }

            // Actualizar la posición de todos los jugadores en el mapa
            const positions = JSON.parse(message);
            actualizarPosicionesJugadores(positions);
            
        };

        socket.onerror = function(error) {
            console.error('Error en la conexión WebSocket:', error);
        };

        socket.onclose = function(event) {
            console.log('Conexión WebSocket cerrada:', event.code, event.reason);
        };

        // Lógica del juego y manejo de eventos
        const canvas = document.getElementById("game-canvas");
        const context = canvas.getContext("2d");
        const playerSize = 20;
        let playerX = canvas.width / 2;
        let playerY = canvas.height / 2;

        // Dibujar el jugador inicialmente en el centro del canvas
        dibujarJugador();

        // Manejo de eventos de teclado
        document.addEventListener("keydown", function(event) {
            // Obtener la tecla presionada
            const key = event.key;

            // Actualizar la posición del jugador según la tecla presionada
            if (key === "ArrowUp" && playerY > 0) {
                playerY -= 10;
            } else if (key === "ArrowDown" && playerY < canvas.height - playerSize) {
                playerY += 10;
            } else if (key === "ArrowLeft" && playerX > 0) {
                playerX -= 10;
            } else if (key === "ArrowRight" && playerX < canvas.width - playerSize) {
                playerX += 10;
            }

            // Enviar la nueva posición del jugador al servidor y refrescar la posición en el canvas
            socket.send(JSON.stringify({ x: playerX, y: playerY }));
            
            // Actualizar la posición del jugador en el canvas de todos los jugadores
            dibujarJugador();
            
        });

        // Función para crear una sala de juego
        function crearSala() {
            // socket.send('CREATE_ROOM');
            let user = prompt("Ingrese su nombre de usuario");
            socket.send('create,'+user);
        }

        // Función para unirse a una sala de juego
        function unirseASala() {
            const code = prompt('Ingrese el código de invitación:');
            let user = prompt("Ingrese su nombre de usuario");
            socket.send('join,' + code);

            socket.send(user);
        }

        function actualizarPosicionesJugadores(positions) {

            // Limpiar el canvas
            context.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar cada jugador en el mapa
            for (const playerName in positions) {
                const player = positions[playerName];
                context.fillStyle = "red";
                context.fillRect(player.x, player.y, playerSize, playerSize);

                // Dibujar el nombre del jugador
                context.fillStyle = "black";
                context.font = "12px Arial";
                context.fillText(playerName, player.x, player.y - 5);
            }
        }

        function dibujarJugador() {
            // Limpiar el canvas
            context.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar el jugador en la posición actualizada
            context.fillStyle = "blue";
            context.fillRect(playerX, playerY, playerSize, playerSize);
        }
    </script>

    <!-- Botones para crear una sala y unirse a una sala -->
    <button onclick="crearSala()">Crear Sala</button>
    <button onclick="unirseASala()">Unirse a Sala</button>
</body>
</html>